<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>DASHBOARD</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css"
        rel="stylesheet" crossorigin="anonymous">

  <style>
  /* ─────────── базовые стили ─────────── */
  .card-img-top      {width:100%;height:200px;object-fit:cover}
  .card-body p       {margin-bottom:.3rem}
  .eff-percent       {font-size:1.6rem;font-weight:700}
  .text-orange       {color:#fd7e14}
  .bg-orange         {background-color:#fd7e14!important}
  .progress          {height:6px}
  .note              {font-size:.85rem;color:#6c757d;opacity:.75}
  img.avatar         {width:110px;height:110px;object-fit:cover}

  /* ─────────── ТВ-режим ─────────── */
  body.tv{overflow:hidden}

  .tv img.avatar{width:150px;height:150px}

  /* колонка “продажи / снабжение” только в TV-mode */
  .tv .dashboard-grid{
    display:grid;
    grid-template-columns: {{ sales_frac }}fr 1fr;  /*  X / 1  */
    gap:1.5rem;
  }

  /* больше столбцов на широкой секции (чтобы влезало по Y) */
  .tv .sales-row      {--bs-columns:8;}   /* 8 столбцов вместо 3 по умолчанию */
  .tv .supplies-row   {--bs-columns:3;}   /* для 4-х снабженцев хватит 3 столбцов */
  </style>

  {% if auto_refresh %}
  <meta http-equiv="refresh" content="{{ auto_refresh }}">
  {% endif %}
</head>

{# body получает .tv ТОЛЬКО по кнопке #}
<body class="bg-light{% if tv_mode %} tv{% endif %}">

<div class="container py-4">

  <!---------------------- Шапка ----------------------->
  <div class="d-flex align-items-start mb-3">
    <h1 class="me-auto mb-0">TURBORAND DASHBOARD</h1>

    <a href="?view={{ 'normal' if tv_mode else 'tv' }}"
       class="btn btn-outline-secondary btn-sm">
       {{ 'Normal mode' if tv_mode else 'TV mode' }}
    </a>
  </div>

  <p class="mb-4"><u>Демо-данные, все показатели вымышленные</u></p>

  <!---------------------- TV-grid (добавляется только в ТВ-режиме) ----------------------->
  <div class="{% if tv_mode %}dashboard-grid{% endif %}">

    <!---------------------- Продажи ----------------------->
    <section>
      <h3 class="mb-3">Продажи</h3>

      <form method="get" class="mb-3">
        <input type="hidden" name="view" value="{{ 'tv' if tv_mode else 'normal' }}">
        <label for="period" class="form-label me-2">Период:</label>
        <select class="form-select w-auto d-inline-block" id="period"
                name="period" onchange="this.form.submit()">
          <option value="3m" {% if period == '3m' %}selected{% endif %}>3 месяца</option>
          <option value="1m" {% if period == '1m' %}selected{% endif %}>Месяц</option>
          <option value="1w" {% if period == '1w' %}selected{% endif %}>Неделя</option>
          <option value="3d" {% if period == '3d' %}selected{% endif %}>3 дня</option>
        </select>
      </form>

      <div class="row g-4 row-cols-1 row-cols-sm-2 row-cols-md-3
                  row-cols-xl-4 sales-row">
        {% for m in managers %}
        <div class="col">
          <div class="card h-100 shadow-sm p-3">
            <div class="d-flex">
              <img src="{{ m.photo_url }}" alt="{{ m.name }}"
                   class="avatar rounded me-3">

              <div class="flex-grow-1">
                <h5 class="mb-1">{{ m.name }}</h5>
                <p class="text-muted mb-2 small">{{ m.position }}</p>
                <p>Эффективность:
                  <span class="eff-percent {{ m.eff_class }}">{{ m.eff }} %</span>
                </p>
              </div>
            </div>

            <hr class="my-2">

            <div class="text-center small">
              <div>КП: <strong>{{ m.kp_count }}</strong></div>
              <div>Звонки (мин): <strong>{{ m.calls_minutes }}</strong></div>
              <div>Командировок: <strong>{{ m.trips_count }}</strong></div>
              <div>Договоров: <strong>{{ m.success_deals }}</strong></div>
              <div>Авансы: <strong>{{ m.advances_rub }}</strong></div>
              <div>Прибыль: <strong>{{ m.profit_rub }}</strong></div>
            </div>

            <div class="progress my-2">
              <div class="progress-bar {{ m.bar_class }}"
                   style="width: {{ m.eff }}%;"></div>
            </div>
            <p class="note text-center">Показатели вымышленные</p>
          </div>
        </div>
        {% endfor %}
      </div>
    </section>

    <!---------------------- Снабжение ----------------------->
    <section>
      <h3 class="mb-3">Снабжение</h3>

      <div class="row g-4 row-cols-1 row-cols-sm-2 supplies-row">
        {% for m in supplies %}
        <div class="col">
          <div class="card h-100 shadow-sm p-3 text-center">
            <img src="{{ m.photo_url }}" class="card-img-top mb-2" alt="{{ m.name }}">
            <h5 class="card-title">{{ m.name }}</h5>
            <p>Эффективность:
              <span class="eff-percent {{ m.eff_class }}">{{ m.eff }} %</span>
            </p>
            <p>Показатель 1: <strong>{{ m.stat1 }}</strong></p>
            <p>Показатель 2: <strong>{{ m.stat2 }}</strong></p>

            <div class="progress my-2">
              <div class="progress-bar {{ m.bar_class }}"
                   style="width: {{ m.eff }}%;"></div>
            </div>
            <p class="note">Показатели вымышленные</p>
          </div>
        </div>
        {% endfor %}
      </div>
    </section>

  </div><!-- /.dashboard-grid (только в TV) -->
</div><!-- /.container -->

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"
        crossorigin="anonymous"></script>
</body>
</html>
